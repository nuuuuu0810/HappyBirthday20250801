<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お誕生日おめでとう！</title>
    <style>
        /* (前略) 基本設定などは変更なし */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        #firefly-container { position: relative; width: 100%; height: 100%; background-image: url('/HappyBirthday20250801/background3.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; }
        .firefly { position: absolute; border-radius: 50%; background: radial-gradient(circle, rgba(220, 255, 100, 0.9) 0%, rgba(220, 255, 100, 0) 70%); box-shadow: 0 0 10px rgba(220, 255, 100, 0.7), 0 0 20px rgba(220, 255, 100, 0.5); }
        .text-firefly-wrapper { position: absolute; }

        /* 背景の蛍のアニメーション (変更なし) */
        .background-firefly {
             animation: flicker-and-move linear infinite;
        }
        @keyframes flicker-and-move {
            0%, 100% { opacity: 0; transform: translate(0, 0) scale(0.8); }
            10% { opacity: 1; transform: translate(-5px, 10px) scale(1); }
            25% { opacity: 0.7; }
            40% { opacity: 1; transform: translate(8px, -5px) scale(1.1); }
            60% { opacity: 0.5; transform: translate(-10px, -8px) scale(0.9); }
            80% { opacity: 1; }
        }

        /* ★変更点1: 文字蛍のアニメーションを、CSSカスタムプロパティを使った1種類に統一 */
        
        .text-firefly-wrapper .firefly {
            animation-name: gather-and-hold-dynamic; /* 新しい動的アニメーションを指定 */
            animation-duration: 5s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        /* 動きの座標をJavaScriptから受け取るためのキーフレーム */
        @keyframes gather-and-hold-dynamic {
            /* 0.5秒間、元の位置で静止するフェーズ */
            0%, 90%, 100% {
                transform: translate(0, 0);
                opacity: 1;
            }
            /* 中間点の座標をCSSカスタムプロパティ(--tx1, --ty1など)で受け取る */
            25% {
                /* var(--tx1, 8px) は、--tx1変数がなければデフォルトで8pxを使う、という意味 */
                transform: translate(var(--tx1, 8px), var(--ty1, -10px));
                opacity: 0.7;
            }
            50% {
                transform: translate(var(--tx2, -5px), var(--ty2, 6px));
                opacity: 0.9;
            }
            75% {
                transform: translate(var(--tx3, 10px), var(--ty3, 10px));
                opacity: 0.6;
            }
        }

    </style>
</head>
<body>
    <div id="firefly-container"></div>
    <canvas id="text-canvas" style="display: none;"></canvas>
    <audio id="bgm" src="/HappyBirthday20250801/06-明日の翼 [久石譲：オリジナルアーティスト](1012706904).mp3" loop></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('firefly-container');
            
            // 背景の蛍 (変更なし)
            const numBackgroundFireflies = 1500;
            for (let i = 0; i < numBackgroundFireflies; i++) {
                const firefly = document.createElement('div');
                firefly.classList.add('firefly', 'background-firefly');
                const x = Math.random() * 100;
                const y_random_factor = Math.pow(Math.random(), 3);
                const y = 100 - (y_random_factor * 50);
                firefly.style.left = `${x}vw`;
                firefly.style.top = `${y}vh`;
                const size = Math.random() * 5 + 2;
                firefly.style.width = `${size}px`;
                firefly.style.height = `${size}px`;
                firefly.style.animationDuration = `${Math.random() * 10 + 5}s`;
                firefly.style.animationDelay = `${Math.random() * 15}s`;
                container.appendChild(firefly);
            }

            // 文字を形成する蛍
            const canvas = document.getElementById('text-canvas');
            const ctx = canvas.getContext('2d');

            function getCharacterCoordinates() {
                const text1 = "HAPPY";
                const text2 = "BIRTHDAY";
                const fontSize = window.innerWidth / 7;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.font = `bold ${fontSize}px 'Arial', sans-serif`;
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const baseY = window.innerHeight * 0.80; 
                ctx.fillText(text1, canvas.width / 2, baseY - fontSize * 0.65);
                ctx.fillText(text2, canvas.width / 2, baseY + fontSize * 0.65);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const coordinates = [];
                const density = 4;
                for (let y = 0; y < canvas.height; y += density) {
                    for (let x = 0; x < canvas.width; x += density) {
                        const alphaIndex = (y * canvas.width + x) * 4 + 3;
                        if (data[alphaIndex] > 128) {
                            coordinates.push({ x, y });
                        }
                    }
                }
                return coordinates;
            }

            function createTextFireflies(coordinates) {
                // ★変更点2: 各蛍の動きをJavaScriptで個別に生成する
                
                // 蛍の動く範囲（数値が大きいほど、より広範囲を飛び回る）
                const moveRange = 15; 

                coordinates.forEach(coord => {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('text-firefly-wrapper');
                    const firefly = document.createElement('div');
                    firefly.classList.add('firefly');
                    
                    // --- ここで各蛍のユニークな動きを生成 ---
                    // -1 ~ 1 の乱数を生成し、moveRangeを掛けることで、上下左右への移動量を決める
                    const tx1 = (Math.random() - 0.5) * 2 * moveRange;
                    const ty1 = (Math.random() - 0.5) * 2 * moveRange;
                    const tx2 = (Math.random() - 0.5) * 2 * moveRange;
                    const ty2 = (Math.random() - 0.5) * 2 * moveRange;
                    const tx3 = (Math.random() - 0.5) * 2 * moveRange;
                    const ty3 = (Math.random() - 0.5) * 2 * moveRange;

                    // 生成した値を、CSSカスタムプロパティとして蛍のスタイルに設定
                    firefly.style.setProperty('--tx1', `${tx1}px`);
                    firefly.style.setProperty('--ty1', `${ty1}px`);
                    firefly.style.setProperty('--tx2', `${tx2}px`);
                    firefly.style.setProperty('--ty2', `${ty2}px`);
                    firefly.style.setProperty('--tx3', `${tx3}px`);
                    firefly.style.setProperty('--ty3', `${ty3}px`);
                    // ----------------------------------------

                    wrapper.style.left = `${coord.x}px`;
                    wrapper.style.top = `${coord.y}px`;

                    const size = Math.random() * 3 + 3;
                    firefly.style.width = `${size}px`;
                    firefly.style.height = `${size}px`;
                    
                    wrapper.appendChild(firefly);
                    container.appendChild(wrapper);
                });
            }
            
            // --- メイン処理 ---
            const coords = getCharacterCoordinates();
            createTextFireflies(coords);

            const bgm = document.getElementById('bgm');
// 音量を少し下げる（0.5 = 50%）
bgm.volume = 0.5; 

// 自動再生を試みる
const playPromise = bgm.play();

if (playPromise !== undefined) {
    playPromise.catch(error => {
        // 自動再生が失敗した場合（ブラウザのポリシーによる）、
        // ユーザーがページをクリックするのを待つ
        console.log("BGMの自動再生がブロックされました。ユーザーの操作を待ちます。");
        document.body.addEventListener('click', () => {
            bgm.play();
        }, { once: true }); // 一度だけ実行されるようにする
    });
}
        });
    </script>
</body>
</html>
